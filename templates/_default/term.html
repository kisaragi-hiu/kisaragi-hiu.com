{{ define "header" }}
<!-- prettier-ignore -->
{{ if .Params.hugo_notitlecase }}
  {{ .Scratch.Set "titlecase" false }}
{{ else }}
  {{ .Scratch.Set "titlecase" true }}
{{ end }}

{{ partial "avatar" .Title }}
{{ partial "heading" (dict "title" .Title) }}
<hr />
<dl class="meta">
  {{ with (partial "func-page-term" (dict "page" . "taxonomy" "tags")) }}
  <div>
    <dt>Tags on this term</dt>
    <dd>{{ range . }} {{ partial "tag" . }} {{ end }}</dd>
  </div>
  {{ end }}
</dl>

<!-- prettier-ignore -->
{{ end }}

{{ define "main" }}

<!-- Display the tags of this term page.
     HACK: getting around the fact that Hugo doesn't seem to allow
     tagging list pages. -->
<!-- NOTE: (dict "page" . "taxonomy" "tags") is not a cons cell!
     The dot is the context dot. Remember this is not Lisp. -->
<!-- prettier-ignore -->

<!-- prettier-ignore -->
{{ if .Params.toc }}
{{ partial "toc" . }}
{{ end }}

{{ if .Params.hugo_nolist }}
  {{ partial "content" . }}
{{ else }}
<root>
  {{ partial "content" . }}

  <!-- Store "term" items under this taxonomy term.
       This does not just work with tags.-->
  <!-- prettier-ignore -->
  {{ $term_items := (slice) }}
  {{ range (where .Site.AllPages "Kind" "term" ) }}
    {{ if (in (.Page.Param $.Data.Plural) (anchorize $.LinkTitle)) }}
      {{$term_items = (union $term_items (slice .Page))}}
    {{ end }}
  {{ end }}

  <!-- Other tags -->
  {{ with $term_items }}

  <h2>{{ printf "Related %s" $.Data.Plural }}</h2>
  <ul class="index">
    {{ range $term_items }}
    <li>{{ partial .Data.Singular . }}</li>
    {{ end }}
  </ul>
  {{ end }}

  <!-- Projects -->
  <!-- prettier-ignore -->
  {{ with (where .Pages "Section" "projects")}}
  <h2>
    Projects under <span class="{{$.Data.Singular}}">{{ $.Data.Term }}</span>
  </h2>
  <!-- prettier-ignore -->
  {{ partial "projects" . }}
  {{ end }}

  <!-- Covers -->
  <!-- prettier-ignore -->
  {{ with (where .Pages "Section" "covers")}}
  <h2>Covers</h2>
  <!-- prettier-ignore -->
  {{ partial "covers" . }}
  {{ end }}

  <!-- Illust -->
  <!-- prettier-ignore -->
  {{ with (where .Pages "Section" "illust") }}
  <h2>Illust</h2>
  <!-- prettier-ignore -->
  {{ range . }}
  {{ partial "illust-item" . }}
  {{ end }}
  {{ end }}

  <!-- Pages -->
  <!-- prettier-ignore -->
  {{ with (sort (union (where .Pages "Section" "")
                       (where .Pages "Section" "blog"))
                "Date"
                "desc") }}
  <h2>
    Posts under <span class="{{$.Data.Singular}}">{{ $.Data.Term }}</span>
  </h2>
  <ul class="index">
    {{ range .}}
    <li>{{ partial "index-item" . }}</li>
    {{ end }}
  </ul>
  {{ end }}
</root>
{{ end }} {{ end }}
